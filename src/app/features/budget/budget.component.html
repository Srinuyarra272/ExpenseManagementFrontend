<div class="p-4 md:p-6 w-full space-y-6">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white tracking-tight">Budget Planning</h1>
            <p class="text-gray-500 dark:text-slate-300 mt-1">Set limits for your spending</p>
        </div>

        <div
            class="flex items-center gap-4 bg-white dark:bg-slate-800 p-1 rounded-xl shadow-sm border border-gray-100 dark:border-slate-800 self-stretch md:self-auto justify-between md:justify-start">
            <button (click)="changeMonth(-1)"
                class="p-2 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-lg text-gray-500 dark:text-white transition-colors flex items-center justify-center">
                <span class="material-icons">chevron_left</span>
            </button>
            <span class="font-semibold text-gray-700 dark:text-slate-300 min-w-[120px] text-center">
                {{ currentDate() | date:'MMMM yyyy' }}
            </span>
            <button (click)="changeMonth(1)"
                class="p-2 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-lg text-gray-500 dark:text-white transition-colors flex items-center justify-center">
                <span class="material-icons">chevron_right</span>
            </button>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
        <div class="card bg-slate-900 text-white !border-none">
            <div class="p-6">
                <p class="text-slate-200 text-sm font-medium mb-1">Total Budget</p>
                <h3 class="text-3xl font-bold">{{ totalBudget() | currency }}</h3>
            </div>
        </div>
        <div class="card">
            <div class="p-6">
                <p class="text-gray-500 dark:text-slate-300 text-sm font-medium mb-1">Total Spent</p>
                <h3 class="text-3xl font-bold text-gray-900 dark:text-white">{{ totalSpent() | currency }}</h3>
            </div>
        </div>
        <div class="card">
            <div class="p-6">
                <p class="text-gray-500 dark:text-slate-300 text-sm font-medium mb-1">Remaining</p>
                <h3 class="text-3xl font-bold"
                    [ngClass]="(totalBudget() - totalSpent()) >= 0 ? 'text-slate-900 dark:text-white' : 'text-slate-900 dark:text-white'">
                    {{ (totalBudget() - totalSpent()) | currency }}
                </h3>
            </div>
        </div>
    </div>



    <!-- Budget List -->
    <div class="card !p-0 overflow-hidden min-h-[400px]">
        <div
            class="p-4 md:p-6 border-b border-gray-100 dark:border-slate-800 flex justify-between items-center bg-gray-50 dark:bg-slate-900/50">
            <h3 class="font-bold text-gray-800 dark:text-white">Category Budgets</h3>
            <button (click)="openAddModal()" class="btn-primary text-sm py-2 px-4 shadow-sm">
                <span class="material-icons text-sm mr-1">add</span> Set Budget
            </button>
        </div>

        <div class="divide-y divide-gray-200 dark:divide-slate-800">
            @for (budget of budgets(); track budget.id) {
            <div class="p-4 md:p-6 hover:bg-gray-50 dark:bg-slate-900 transition-colors group">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-full flex items-center justify-center bg-slate-100 dark:bg-slate-800 text-slate-800 dark:text-white">
                            <span class="material-icons text-lg">{{ budget.categoryIcon }}</span>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-900 dark:text-white text-sm md:text-base">{{
                                budget.categoryName }}</h4>
                            <p class="text-xs text-gray-500 dark:text-slate-300">{{ budget.spent | currency }} spent of
                                {{ budget.amount |
                                currency }}</p>
                        </div>
                    </div>
                    <!-- Actions: Always visible on mobile if needed, or stick to hover on desktop. 
                         Let's keep hover but ensure they are tappable on mobile by showing them if active? 
                         Actually, on mobile hover doesn't work well. Let's make them always visible on mobile or add a menu.
                         For simplicity, I'll make them always visible on mobile, opacity-100 on md:hover. -->
                    <div class="flex items-center gap-2 md:opacity-0 md:group-hover:opacity-100 transition-opacity">
                        <button (click)="editBudget(budget)"
                            class="p-2 text-gray-400 hover:text-slate-900 dark:text-white rounded-lg hover:bg-gray-100">
                            <span class="material-icons text-lg">edit</span>
                        </button>
                        <button (click)="confirmDelete(budget.id)"
                            class="p-2 text-gray-400 hover:text-slate-900 dark:text-white rounded-lg hover:bg-gray-100">
                            <span class="material-icons text-lg">delete</span>
                        </button>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="relative pt-2">
                    <div class="flex justify-between text-xs mb-1 font-medium">
                        <span
                            [ngClass]="budget.percentage > 100 ? 'text-slate-900 dark:text-white' : 'text-gray-600'">{{
                            budget.percentage | number:'1.0-0' }}%</span>
                        <span class="text-gray-400">{{ budget.remaining | currency }} left</span>
                    </div>
                    <div class="w-full bg-gray-100 dark:bg-slate-800 rounded-full h-2 overflow-hidden">
                        <div class="h-full rounded-full transition-all duration-500"
                            [style.width.%]="budget.percentage > 100 ? 100 : budget.percentage" [ngClass]="{
                                 'bg-slate-800 dark:bg-slate-300': budget.percentage < 80,
                                 'bg-slate-900 dark:bg-white': budget.percentage >= 80
                             }">
                        </div>
                    </div>
                </div>
            </div>
            } @empty {
            <div class="p-12 text-center text-gray-400">
                <span class="material-icons text-5xl mb-4 opacity-20">savings</span>
                <p>No budgets set for this month.</p>
                <button (click)="openAddModal()"
                    class="mt-4 text-slate-800 dark:text-slate-200 font-medium hover:underline">Set your first
                    budget</button>
            </div>
            }
        </div>
    </div>
</div>

<!-- Modal -->
@if (showAddModal()) {
<div class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 dark:bg-slate-900 bg-opacity-75 transition-opacity"
            (click)="closeModal()"></div>

        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

        <div
            class="inline-block align-bottom bg-white dark:bg-slate-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full border border-gray-100 dark:border-slate-700">
            <div class="bg-white dark:bg-slate-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="modal-title">
                    {{ editingBudget() ? 'Edit Budget' : 'Set New Budget' }}
                </h3>
                <form [formGroup]="budgetForm" class="mt-4 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-slate-300">Category</label>
                        <select formControlName="categoryId" class="input-field mt-1">
                            <option value="">Select Category</option>
                            <!-- If editing, allow showing the current category even if filtered out -->
                            @if (editingBudget()) {
                            <option [value]="editingBudget()!.categoryId">{{ editingBudget()!.categoryName }}</option>
                            }
                            @for (cat of availableCategories; track cat.id) {
                            <option [value]="cat.id">{{ cat.name }}</option>
                            }
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-slate-300">Monthly Limit</label>
                        <div class="relative mt-1">
                            <span class="absolute left-3 top-2 text-gray-500 dark:text-slate-300">â‚¹</span>
                            <input type="number" formControlName="amount" class="input-field pl-7">
                        </div>
                    </div>
                </form>
            </div>
            <div class="bg-gray-50 dark:bg-slate-900 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button (click)="onSubmit()" [disabled]="budgetForm.invalid"
                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-slate-900 text-base font-medium text-white hover:bg-slate-800 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm disabled:opacity-50">
                    Save
                </button>
                <button (click)="closeModal()"
                    class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white dark:bg-slate-800 text-base font-medium text-gray-700 dark:text-slate-300 hover:bg-gray-50 dark:bg-slate-900 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>
}

<!-- Delete Confirmation Modal -->
@if (showDeleteModal()) {
<div class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 dark:bg-slate-900 bg-opacity-75 transition-opacity"
            (click)="cancelDelete()"></div>

        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

        <div
            class="inline-block align-bottom bg-white dark:bg-slate-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-md w-full border border-gray-100 dark:border-slate-700">
            <div class="bg-white dark:bg-slate-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div
                        class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-slate-100 sm:mx-0 sm:h-10 sm:w-10">
                        <span class="material-icons text-slate-900 dark:text-white">warning</span>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">Delete Budget</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500 dark:text-slate-300">
                                Are you sure you want to delete this budget? This action cannot be undone.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 dark:bg-slate-900 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button (click)="deleteBudget()"
                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-slate-900 text-base font-medium text-white hover:bg-slate-800 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                    Delete
                </button>
                <button (click)="cancelDelete()"
                    class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white dark:bg-slate-800 text-base font-medium text-gray-700 dark:text-slate-300 hover:bg-gray-50 dark:bg-slate-900 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>
}